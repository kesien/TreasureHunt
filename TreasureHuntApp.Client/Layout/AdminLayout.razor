@using TreasureHuntApp.Client.Services
@inherits LayoutComponentBase
@inject IAdminAuthService AdminAuthService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudSpacer />
        <MudText Typo="Typo.h6">TreasureHunt Admin</MudText>
        <MudSpacer />
        <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" Direction="Direction.Bottom" OffsetX="true">
            <MudMenuItem OnClick="@LogoutAsync">
                <div class="d-flex align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Logout" class="mr-2" />
                    <MudText>Kijelentkezés</MudText>
                </div>
            </MudMenuItem>
        </MudMenu>
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">Navigáció</MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Href="/admin/dashboard" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Dashboard">
                Dashboard
            </MudNavLink>
            <MudNavLink Href="/admin/events" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Event">
                Események
            </MudNavLink>
            <MudDivider Class="my-2" />
            <MudNavGroup Text="Monitoring" Icon="@Icons.Material.Filled.Monitor" Expanded="false">
                <MudNavLink Href="/admin/teams" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Group">
                    Csapatok
                </MudNavLink>
                <MudNavLink Href="/admin/monitor" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.LocationOn">
                    Élő Követés
                </MudNavLink>
            </MudNavGroup>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent Class="pt-16 px-16">
        <MudContainer MaxWidth="MaxWidth.False" Class="my-16">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var isAuthenticated = await AdminAuthService.IsAuthenticatedAsync();
            if (!isAuthenticated)
            {
                Navigation.NavigateTo("/admin/login");
            }
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task LogoutAsync()
    {
        var result = await DialogService.ShowMessageBox(
            "Kijelentkezés",
            "Biztos, hogy ki szeretne jelentkezni?",
            yesText: "Igen", cancelText: "Mégse");

        if (result == true)
        {
            await AdminAuthService.LogoutAsync();
            Navigation.NavigateTo("/admin/login");
        }
    }
}